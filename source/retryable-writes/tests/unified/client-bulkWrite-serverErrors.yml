description: "client bulkWrite retryable writes"
schemaVersion: "1.18"
runOnRequirements:
  - minServerVersion: "8.0"
    topologies: [ replicaset ]

createEntities:
  - client:
      id: &client0 client0
      observeEvents: [ commandStartedEvent ]
  - database:
      id: &database0 database0
      client: *client0
      databaseName: &database0Name retryable-writes-tests
  - collection:
      id: &collection0 collection0
      database: *database0
      collectionName: &collection0Name coll0

initialData:
  - collectionName: *collection0Name
    databaseName: *database0Name
    documents:
      - { _id: 1, x: 11 }
      - { _id: 2, x: 22 }
      - { _id: 3, x: 33 }

tests:
  - description: "client bulkWrite with no multi: true operations succeeds after retryable top-level error"
    operations:
      - object: testRunner
        name: failPoint
        arguments:
          client: *client0
          failPoint:
            configureFailPoint: failCommand
            mode:
              times: 1
            data:
              failCommands: [ bulkWrite ]
              errorCode: 189 # PrimarySteppedDown
              errorLabels: [ RetryableWriteError ]
      - object: *client0
        name: clientBulkWrite
        arguments:
          requests:
            - insertOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                document: { _id: 4, x: 44 }
            - updateOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 1 }
                update:
                  $inc: { x: 1 }
            - replaceOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 2 }
                replacement: { x: 222 }
            - deleteOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 3 }
        expectResult:
          insertedCount: 1
          upsertedCount: 0
          matchedCount: 2
          modifiedCount: 2
          deletedCount: 1
          insertResults:
            $$unsetOrMatches: {}
          updateResults:
            $$unsetOrMatches: {}
          deleteResults:
            $$unsetOrMatches: {}
    expectEvents:
      - client: *client0
        events:
          - commandStartedEvent:
              command:
                bulkWrite: 1
          - commandStartedEvent:
              command:
                bulkWrite: 1
    outcome:
      - collectionName: *collection0Name
        databaseName: *database0Name
        documents:
          - { _id: 1, x: 12 }
          - { _id: 2, x: 222 }
          - { _id: 4, x: 44 }
  - description: "client bulkWrite with multi: true operations fails after retryable top-level error"
    operations:
      - object: testRunner
        name: failPoint
        arguments:
          client: *client0
          failPoint:
            configureFailPoint: failCommand
            mode:
              times: 1
            data:
              failCommands: [ bulkWrite ]
              errorCode: 189 # PrimarySteppedDown
              errorLabels: [ RetryableWriteError ]
      - object: *client0
        name: clientBulkWrite
        arguments:
          requests:
            - insertOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name 
                document: { _id: 4, x: 44 }
            - updateOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 1 }
                update:
                  $inc: { x: 1 }
            - replaceOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 2 }
                replacement: { x: 222 }
            - deleteOne:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 3 }
        expectError:
          errorCode: 189
          errorLabelsContain: [ RetryableWriteError ]
        expectResult:
          insertedCount: 1
          upsertedCount: 0
          matchedCount: 2
          modifiedCount: 2
          deletedCount: 1
          insertResults:
            $$unsetOrMatches: {}
          updateResults:
            $$unsetOrMatches: {}
          deleteResults:
            $$unsetOrMatches: {}
    expectEvents:
      - client: *client0
        events:
          - commandStartedEvent:
              command:
                bulkWrite: 1
  - description: "client bulkWrite with multi: true operations fails after retryable writeConcernError"
    operations:
      - object: testRunner
        name: failPoint
        arguments:
          client: *client0
          failPoint:
            configureFailPoint: failCommand
            mode:
              times: 1
            data:
              failCommands: [ bulkWrite ]
              errorLabels: [ RetryableWriteError ]
              writeConcernError: &writeConcernError
                code: 91
                errmsg: "Replication is being shut down"
      - object: *client0
        name: clientBulkWrite
        arguments:
          requests:
            - updateMany:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 1 }
                update:
                  $inc: { x: 1 }
            - deleteMany:
                namespace:
                  db: *database0Name
                  coll: *collection0Name
                filter: { _id: 3 }
        expectError:
          writeConcernErrors: [ *writeConcernError ]
          expectResult:
            insertedCount: 0
            upsertedCount: 0
            matchedCount: 1
            modifiedCount: 1
            deletedCount: 1
            insertResults:
              $$unsetOrMatches: {}
            updateResults:
              $$unsetOrMatches: {}
            deleteResults:
              $$unsetOrMatches: {}
    expectEvents:
      - client: *client0
        events:
          - commandStartedEvent:
              command:
                bulkWrite: 1
